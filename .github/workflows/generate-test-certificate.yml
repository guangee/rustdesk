name: Generate Test Certificate

on:
  workflow_dispatch:  # 手动触发

jobs:
  generate-certificate:
    name: Generate Windows Test Certificate
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate test certificate
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  生成 Windows 测试签名证书" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          
          # 配置证书参数
          $certSubject = "CN=RustDesk Test Certificate, O=RustDesk Test, C=US"
          $certPassword = "RustDeskTest2024!"
          
          Write-Host "[1/4] 创建自签名证书..." -ForegroundColor Yellow
          
          # 创建自签名证书
          $cert = New-SelfSignedCertificate `
              -Type CodeSigningCert `
              -Subject $certSubject `
              -KeyUsage DigitalSignature `
              -FriendlyName "RustDesk Test Code Signing Certificate" `
              -CertStoreLocation "Cert:\CurrentUser\My" `
              -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}") `
              -NotAfter (Get-Date).AddYears(5)
          
          if (-not $cert) {
              Write-Host "❌ 证书创建失败！" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "✅ 证书创建成功" -ForegroundColor Green
          Write-Host "   Thumbprint: $($cert.Thumbprint)" -ForegroundColor Gray
          Write-Host ""
          
          Write-Host "[2/4] 导出证书为 PFX 格式..." -ForegroundColor Yellow
          
          # 导出为 PFX
          $password = ConvertTo-SecureString -String $certPassword -Force -AsPlainText
          $pfxPath = "rustdesk-test-cert.pfx"
          
          try {
              Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $password | Out-Null
              Write-Host "✅ PFX 导出成功: $pfxPath" -ForegroundColor Green
          } catch {
              Write-Host "❌ PFX 导出失败: $_" -ForegroundColor Red
              exit 1
          }
          Write-Host ""
          
          Write-Host "[3/4] 转换为 Base64 编码..." -ForegroundColor Yellow
          
          # 转换为 Base64
          try {
              $base64 = [Convert]::ToBase64String([IO.File]::ReadAllBytes($pfxPath))
              $base64 | Out-File "rustdesk-test-cert-base64.txt"
              Write-Host "✅ Base64 编码成功" -ForegroundColor Green
          } catch {
              Write-Host "❌ Base64 转换失败: $_" -ForegroundColor Red
              exit 1
          }
          Write-Host ""
          
          Write-Host "[4/4] 生成配置信息..." -ForegroundColor Yellow
          Write-Host ""
          
          # 显示配置信息
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "  证书配置信息" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "🔐 GitHub Secrets 配置:" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "   Secret 名称: WINDOWS_CERTIFICATE_BASE64" -ForegroundColor Yellow
          Write-Host "   Secret 值: (见下方 artifact 中的文件)" -ForegroundColor Gray
          Write-Host ""
          Write-Host "   Secret 名称: WINDOWS_CERTIFICATE_PASSWORD" -ForegroundColor Yellow
          Write-Host "   Secret 值: $certPassword" -ForegroundColor Gray
          Write-Host ""
          Write-Host "📋 下一步操作:" -ForegroundColor Cyan
          Write-Host "   1. 下载下方的 artifact (test-certificate)" -ForegroundColor White
          Write-Host "   2. 解压并打开 rustdesk-test-cert-base64.txt" -ForegroundColor White
          Write-Host "   3. 复制文件的全部内容" -ForegroundColor White
          Write-Host "   4. 在 GitHub Settings -> Secrets 中配置" -ForegroundColor White
          Write-Host ""
          Write-Host "⚠️  重要提示:" -ForegroundColor Red
          Write-Host "   • 这是测试证书，用户仍会看到安全警告" -ForegroundColor Yellow
          Write-Host "   • 证书密码: $certPassword" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "✅ 证书生成完成！" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
      
      - name: Upload certificate files
        uses: actions/upload-artifact@v4
        with:
          name: test-certificate
          path: |
            rustdesk-test-cert-base64.txt
          retention-days: 7
      
      - name: Display instructions
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  📥 如何使用生成的证书" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "1️⃣ 下载 Artifact" -ForegroundColor Yellow
          Write-Host "   • 在本次运行页面底部找到 'test-certificate'" -ForegroundColor White
          Write-Host "   • 点击下载并解压" -ForegroundColor White
          Write-Host ""
          Write-Host "2️⃣ 配置 GitHub Secrets" -ForegroundColor Yellow
          Write-Host "   • 进入仓库 Settings -> Secrets and variables -> Actions" -ForegroundColor White
          Write-Host "   • 点击 'New repository secret'" -ForegroundColor White
          Write-Host ""
          Write-Host "3️⃣ 添加第一个 Secret" -ForegroundColor Yellow
          Write-Host "   Name:  WINDOWS_CERTIFICATE_BASE64" -ForegroundColor Cyan
          Write-Host "   Value: (粘贴 rustdesk-test-cert-base64.txt 的全部内容)" -ForegroundColor Gray
          Write-Host ""
          Write-Host "4️⃣ 添加第二个 Secret" -ForegroundColor Yellow
          Write-Host "   Name:  WINDOWS_CERTIFICATE_PASSWORD" -ForegroundColor Cyan
          Write-Host "   Value: RustDeskTest2024!" -ForegroundColor Gray
          Write-Host ""
          Write-Host "5️⃣ 触发构建" -ForegroundColor Yellow
          Write-Host "   git push" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "✨ 完成后您的应用将自动签名！" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green

