name: Generate Test Certificate

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  generate-certificate:
    name: Generate Windows Test Certificate
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate test certificate
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  ç”Ÿæˆ Windows æµ‹è¯•ç­¾åè¯ä¹¦" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          
          # é…ç½®è¯ä¹¦å‚æ•°
          $certSubject = "CN=RustDesk Test Certificate, O=RustDesk Test, C=US"
          $certPassword = "RustDeskTest2024!"
          
          Write-Host "[1/4] åˆ›å»ºè‡ªç­¾åè¯ä¹¦..." -ForegroundColor Yellow
          
          # åˆ›å»ºè‡ªç­¾åè¯ä¹¦
          $cert = New-SelfSignedCertificate `
              -Type CodeSigningCert `
              -Subject $certSubject `
              -KeyUsage DigitalSignature `
              -FriendlyName "RustDesk Test Code Signing Certificate" `
              -CertStoreLocation "Cert:\CurrentUser\My" `
              -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}") `
              -NotAfter (Get-Date).AddYears(5)
          
          if (-not $cert) {
              Write-Host "âŒ è¯ä¹¦åˆ›å»ºå¤±è´¥ï¼" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "âœ… è¯ä¹¦åˆ›å»ºæˆåŠŸ" -ForegroundColor Green
          Write-Host "   Thumbprint: $($cert.Thumbprint)" -ForegroundColor Gray
          Write-Host ""
          
          Write-Host "[2/4] å¯¼å‡ºè¯ä¹¦ä¸º PFX æ ¼å¼..." -ForegroundColor Yellow
          
          # å¯¼å‡ºä¸º PFX
          $password = ConvertTo-SecureString -String $certPassword -Force -AsPlainText
          $pfxPath = "rustdesk-test-cert.pfx"
          
          try {
              Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $password | Out-Null
              Write-Host "âœ… PFX å¯¼å‡ºæˆåŠŸ: $pfxPath" -ForegroundColor Green
          } catch {
              Write-Host "âŒ PFX å¯¼å‡ºå¤±è´¥: $_" -ForegroundColor Red
              exit 1
          }
          Write-Host ""
          
          Write-Host "[3/4] è½¬æ¢ä¸º Base64 ç¼–ç ..." -ForegroundColor Yellow
          
          # è½¬æ¢ä¸º Base64
          try {
              $base64 = [Convert]::ToBase64String([IO.File]::ReadAllBytes($pfxPath))
              $base64 | Out-File "rustdesk-test-cert-base64.txt"
              Write-Host "âœ… Base64 ç¼–ç æˆåŠŸ" -ForegroundColor Green
          } catch {
              Write-Host "âŒ Base64 è½¬æ¢å¤±è´¥: $_" -ForegroundColor Red
              exit 1
          }
          Write-Host ""
          
          Write-Host "[4/4] ç”Ÿæˆé…ç½®ä¿¡æ¯..." -ForegroundColor Yellow
          Write-Host ""
          
          # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "  è¯ä¹¦é…ç½®ä¿¡æ¯" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ” GitHub Secrets é…ç½®:" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "   Secret åç§°: WINDOWS_CERTIFICATE_BASE64" -ForegroundColor Yellow
          Write-Host "   Secret å€¼: (è§ä¸‹æ–¹ artifact ä¸­çš„æ–‡ä»¶)" -ForegroundColor Gray
          Write-Host ""
          Write-Host "   Secret åç§°: WINDOWS_CERTIFICATE_PASSWORD" -ForegroundColor Yellow
          Write-Host "   Secret å€¼: $certPassword" -ForegroundColor Gray
          Write-Host ""
          Write-Host "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:" -ForegroundColor Cyan
          Write-Host "   1. ä¸‹è½½ä¸‹æ–¹çš„ artifact (test-certificate)" -ForegroundColor White
          Write-Host "   2. è§£å‹å¹¶æ‰“å¼€ rustdesk-test-cert-base64.txt" -ForegroundColor White
          Write-Host "   3. å¤åˆ¶æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹" -ForegroundColor White
          Write-Host "   4. åœ¨ GitHub Settings -> Secrets ä¸­é…ç½®" -ForegroundColor White
          Write-Host ""
          Write-Host "âš ï¸  é‡è¦æç¤º:" -ForegroundColor Red
          Write-Host "   â€¢ è¿™æ˜¯æµ‹è¯•è¯ä¹¦ï¼Œç”¨æˆ·ä»ä¼šçœ‹åˆ°å®‰å…¨è­¦å‘Š" -ForegroundColor Yellow
          Write-Host "   â€¢ è¯ä¹¦å¯†ç : $certPassword" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "âœ… è¯ä¹¦ç”Ÿæˆå®Œæˆï¼" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
      
      - name: Upload certificate files
        uses: actions/upload-artifact@v4
        with:
          name: test-certificate
          path: |
            rustdesk-test-cert-base64.txt
          retention-days: 7
      
      - name: Display instructions
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  ğŸ“¥ å¦‚ä½•ä½¿ç”¨ç”Ÿæˆçš„è¯ä¹¦" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "1ï¸âƒ£ ä¸‹è½½ Artifact" -ForegroundColor Yellow
          Write-Host "   â€¢ åœ¨æœ¬æ¬¡è¿è¡Œé¡µé¢åº•éƒ¨æ‰¾åˆ° 'test-certificate'" -ForegroundColor White
          Write-Host "   â€¢ ç‚¹å‡»ä¸‹è½½å¹¶è§£å‹" -ForegroundColor White
          Write-Host ""
          Write-Host "2ï¸âƒ£ é…ç½® GitHub Secrets" -ForegroundColor Yellow
          Write-Host "   â€¢ è¿›å…¥ä»“åº“ Settings -> Secrets and variables -> Actions" -ForegroundColor White
          Write-Host "   â€¢ ç‚¹å‡» 'New repository secret'" -ForegroundColor White
          Write-Host ""
          Write-Host "3ï¸âƒ£ æ·»åŠ ç¬¬ä¸€ä¸ª Secret" -ForegroundColor Yellow
          Write-Host "   Name:  WINDOWS_CERTIFICATE_BASE64" -ForegroundColor Cyan
          Write-Host "   Value: (ç²˜è´´ rustdesk-test-cert-base64.txt çš„å…¨éƒ¨å†…å®¹)" -ForegroundColor Gray
          Write-Host ""
          Write-Host "4ï¸âƒ£ æ·»åŠ ç¬¬äºŒä¸ª Secret" -ForegroundColor Yellow
          Write-Host "   Name:  WINDOWS_CERTIFICATE_PASSWORD" -ForegroundColor Cyan
          Write-Host "   Value: RustDeskTest2024!" -ForegroundColor Gray
          Write-Host ""
          Write-Host "5ï¸âƒ£ è§¦å‘æ„å»º" -ForegroundColor Yellow
          Write-Host "   git push" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "âœ¨ å®Œæˆåæ‚¨çš„åº”ç”¨å°†è‡ªåŠ¨ç­¾åï¼" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green

